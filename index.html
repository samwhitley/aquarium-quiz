<!DOCTYPE html>
<html>
  <head>
    <title>Puzzle Aquarium</title>
    <meta name="Description" content="A simple game that was made in HTML5 Canvas">
  </head>
  <body>

    <script src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
    <script src="scripts/resources.js"></script>
    <script src="scripts/sprite.js"></script>
    <script>
      var AQUARIUM = {};

      AQUARIUM.game = (function() {

        AQUARIUM.width = 500;
        AQUARIUM.height = 500;

        var requestAnimFrame = window.requestAnimationFrame || window.webkitRequestAnimationFrame || window.mozRequestAnimationFrame || window.oRequestAnimationFrame || window.msRequestAnimationFrame || function(callback){ window.setTimeout(callback, 1000 / 60); },
            canvas,
            ctx,
            lastTime,
            fish = [], // all fish objects
            fishCount = 20 + (Math.floor(Math.random() * 30) + 1), // total number of fish - from 21 to 50
            fishSpecs = [ // specs for new fish objects
              {
                type: "small",
                size: [57, 26],
                colors: [
                  {
                    name: "green",
                    pos: [90, 0]
                  },
                  {
                    name: "red",
                    pos: [90, 27]
                  },
                  {
                    name: "orange",
                    pos: [90, 55]
                  }
                ]
              },
              {
                type: "medium",
                size: [88, 44],
                colors: [
                  {
                    name: "green",
                    pos: [0, 0]
                  },
                  {
                    name: "red",
                    pos: [0, 45]
                  },
                  {
                    name: "orange",
                    pos: [0, 90]
                  }
                ]
              },
              {
                type: "large",
                size: [97, 101],
                colors: [
                  {
                    name: "green",
                    pos: [150, 0]
                  },
                  {
                    name: "red",
                    pos: [150, 102]
                  },
                  {
                    name: "orange",
                    pos: [150, 204]
                  }
                ]
              }
            ];

        /**
          @method randomIndex - picks random index in an array

          @param {Array} arr
          @return {Number}
        */

        function randomIndex(arr) {
          return Math.floor(Math.random() * arr.length);
        }

        /**
          @method newFish - creates a new random fish

          @return {Object} newFish - fish object with random starting position, type, and color
        */

        function newFish() {
          var typeIndex = randomIndex(fishSpecs),
              currChoice = fishSpecs[typeIndex],
              colorIndex = randomIndex(currChoice.colors),
              currColor = currChoice.colors[colorIndex],
              newFish = {},
              startX = Math.floor(Math.random() * AQUARIUM.width + 1),
              startY = Math.floor(Math.random() * AQUARIUM.height + 1);

          // If the object's width extends offscreen, move it left so it fits
          if (startX + currChoice.size[0] > AQUARIUM.width) {
            startX -= currChoice.size[0];
          }

          // If the object's height extends offscreen, move it up so it fits
          if (startY + currChoice.size[1] > AQUARIUM.height) {
            startY -= currChoice.size[1];
          }

          newFish.pos = [startX, startY];
          newFish.type = currChoice.type;
          newFish.color = currColor.name;
          newFish.sprite = new Sprite("images/sprite-sheet.png", currColor.pos, currChoice.size);

          return newFish;
        }

        /**
          @method init - initial setup for the game
        */

        function init() {
          console.log("init()");

          canvas = document.createElement("canvas");
          ctx = canvas.getContext("2d");
          canvas.width = AQUARIUM.width;
          canvas.height = AQUARIUM.height;
          document.body.appendChild(canvas);

          lastTime = Date.now();

          for (var i = 0; i < fishCount; i++) {
            fish.push(newFish());
          }

          resources.load("images/sprite-sheet.png");
          resources.onReady(main);
        }

        /**
          @method main - main game loop that updates objects and renders them
        */

        function main() {
          var now = Date.now(),
              dt = (now - lastTime) / 1000.0;

          update(dt);
          render();

          requestAnimFrame(main);
        }

        /**
          @method main - updates information about game objects like position
        */

        function update(dt) {
          // console.log("update()");

          // for (var i = 0, len = fish.length; i < len; i++) {
          //   fish[i].pos[0] += (1 * dt);
          // }
        }

        /**
          @method render - clears the screen and draws all game objects
        */

        function render() {
          ctx.fillRect(0, 0, canvas.width, canvas.height);
          renderEntities(fish);
        }

        /**
          @method renderEntities - helper that loops through game objects and renders them
        */

        function renderEntities(list) {
          for(var i=0; i < list.length; i++) {
            renderEntity(list[i]);
          }
        }

        /**
          @method renderEntity - draws an individual game object to the screen
        */

        function renderEntity(entity) {
          ctx.save();
          ctx.translate(entity.pos[0], entity.pos[1]);
          entity.sprite.render(ctx);
          ctx.restore();
        }

        return {
          init: init
        };
      }());


      $(document).ready(function() {
        AQUARIUM.game.init();
      });
    </script>
  </body>
</html>